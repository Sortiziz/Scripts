<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Rutas BGP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        #cy {
            width: 100%;
            height: 80vh;
            border: 1px solid #ccc;
            background-color: #fff;
        }
    </style>
</head>
<body>
    <h1>Mapa de Rutas BGP</h1>
    <div id="cy"></div>

    <script>
        const bgp_map = {
            device_info: {
                "R1": "Router R1\nIP: 1.1.1.0/24\nAS: 100\nModelo: Cisco Router",
                "R2": "Router R2\nIP: 2.2.2.0/24\nAS: 200\nModelo: Juniper Router",
                "R3": "Router R3\nIP: 3.3.3.0/24\nAS: 200\nModelo: Nokia Router",
                "R4": "Router R4\nIP: 4.4.4.0/24\nAS: 300\nModelo: Huawei Router",
                "R5": "Router R5\nIP: 5.5.5.0/24\nAS: 400\nModelo: Dell Router"
            },
            as_groups: {
                100: ["R1"],
                200: ["R2", "R3"],
                300: ["R4"],
                400: ["R5"]
            }
        };

        // Simulación de datos JSON (bgp_graph.json)
        const data = {
            nodes: [
                { data: { id: "R1", label: "R1 (1.1.1.0/24)" }, position: { x: 100, y: 100 } },
                { data: { id: "R2", label: "R2 (2.2.2.0/24)" }, position: { x: 300, y: 200 } },
                { data: { id: "R3", label: "R3 (3.3.3.0/24)" }, position: { x: 300, y: 300 } },
                { data: { id: "R4", label: "R4 (4.4.4.0/24)" }, position: { x: 500, y: 100 } },
                { data: { id: "R5", label: "R5 (5.5.5.0/24)" }, position: { x: 500, y: 300 } }
            ],
            edges: [
                { data: { source: "R1", target: "R2", weight: "10.12.12.0/24" } },
                { data: { source: "R2", target: "R3", weight: "10.23.23.0/24" } },
                { data: { source: "R2", target: "R4", weight: "10.24.24.0/24" } },
                { data: { source: "R3", target: "R5", weight: "10.35.35.0/24" } }
            ]
        };

        const cy = cytoscape({
            container: document.getElementById('cy'),
            elements: data,
            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': 'lightgreen',
                        'label': 'data(label)',
                        'text-valign': 'top',
                        'text-halign': 'center',
                        'width': 40,
                        'height': 40,
                        'font-size': 12,
                        'border-width': 2,
                        'border-color': '#000'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#999',
                        'target-arrow-color': '#999',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        'label': 'data(weight)',
                        'font-size': 10,
                        'text-margin-y': -10
                    }
                },
                {
                    selector: '.as-node',
                    style: {
                        'background-color': 'transparent',
                        'background-opacity': 0,
                        'border-width': 2,
                        'border-color': 'black',
                        'border-style': 'dashed',
                        'shape': 'rectangle', // Cambiado a rectángulo para reflejar "cuadrado"
                        'width': 150,
                        'height': 150,
                        'label': 'data(label)',
                        'font-size': 12,
                        'text-valign': 'top',   // Texto en la parte superior
                        'text-halign': 'left',  // Alineado a la izquierda
                        'text-margin-y': -20,   // Mueve el texto hacia arriba, fuera del nodo
                        'text-margin-x': -75    // Alinea aproximadamente con el borde izquierdo
                    }
                }
            ],
            layout: {
                name: 'preset',
                padding: 50,
                fit: true
            }
        });

        // Añadir nodos AS como padres
        for (const [as_number, routers] of Object.entries(bgp_map.as_groups)) {
            const asNodes = routers.map(r => cy.getElementById(r));
            const asPos = asNodes.reduce((acc, node) => {
                const pos = node.position();
                return {
                    x: acc.x + pos.x / asNodes.length,
                    y: acc.y + pos.y / asNodes.length
                };
            }, { x: 0, y: 0 });

            cy.add({
                group: 'nodes',
                data: { id: `AS_${as_number}`, label: `AS ${as_number}` },
                position: asPos,
                classes: 'as-node'
            });

            asNodes.forEach(node => node.move({ parent: `AS_${as_number}` }));
        }

        // Ajustar dinámicamente text-margin-x para alinear el texto con el borde izquierdo
        cy.nodes('.as-node').forEach(node => {
            const width = node.width();
            node.style('text-margin-x', -width / 2); // Alinea el texto exactamente en el borde izquierdo
        });

        // Mostrar información al hacer doble clic
        cy.on('tap', 'node', evt => {
            const node = evt.target;
            if (node.data('id') && !node.hasClass('as-node')) {
                if (evt.originalEvent.detail === 2) {
                    alert(node.data('label') + '\n' + bgp_map.device_info[node.data('id')]);
                }
            }
        });
    </script>
</body>
</html>