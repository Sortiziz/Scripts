<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Rutas BGP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        #cy {
            width: 100%;
            height: 80vh;
            border: 1px solid #ccc;
            background-color: #fff;
        }
    </style>
</head>
<body>
    <h1>Mapa de Rutas BGP</h1>
    <div id="cy"></div>

    <script>
        const bgp_map = {
            device_info: {
                "R1": "Router R1\nIP: 1.1.1.0/24\nAS: 100\nModelo: Cisco Router",
                "R2": "Router R2\nIP: 2.2.2.0/24\nAS: 200\nModelo: Juniper Router",
                "R3": "Router R3\nIP: 3.3.3.0/24\nAS: 200\nModelo: Nokia Router",
                "R4": "Router R4\nIP: 4.4.4.0/24\nAS: 300\nModelo: Huawei Router",
                "R5": "Router R5\nIP: 5.5.5.0/24\nAS: 400\nModelo: Dell Router"
            },
            as_groups: {
                100: ["R1"],
                200: ["R2", "R3"],
                300: ["R4"],
                400: ["R5"]
            }
        };

        fetch('bgp_graph.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`No se pudo cargar bgp_graph.json: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data || !Array.isArray(data.nodes) || !Array.isArray(data.edges)) {
                    throw new Error('Formato de bgp_graph.json inválido');
                }

                const cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: data,
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'background-color': 'lightgreen',
                                'label': 'data(label)',
                                'text-valign': 'top',
                                'text-halign': 'center',
                                'width': 40,
                                'height': 40,
                                'font-size': 12,
                                'border-width': 2,
                                'border-color': '#000'
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 2,
                                'line-color': '#999',
                                'target-arrow-color': '#999',
                                'target-arrow-shape': 'triangle',
                                'curve-style': 'bezier',
                                'label': 'data(weight)',
                                'font-size': 10,
                                'text-margin-y': -10
                            }
                        },
                        {
                            selector: '.as-node',
                            style: {
                                'background-color': 'transparent',
                                'background-opacity': 0,
                                'border-width': 2,
                                'border-color': 'black',
                                'border-style': 'dashed',
                                'shape': 'ellipse',
                                'width': 150,
                                'height': 150,
                                'label': 'data(label)',
                                'font-size': 12,
                                'text-valign': 'top',
                                'text-halign': 'center',
                                'text-margin-y': -5  // Ajustado para acercar el texto al nodo
                            }
                        },
                        {
                            selector: 'node:parent',
                            style: {
                                'background-color': 'transparent',
                                'background-opacity': 0
                            }
                        }
                    ],
                    layout: {
                        name: 'preset',
                        padding: 50,
                        fit: true
                    }
                });

                // Añadir nodos AS como padres
                for (const [as_number, routers] of Object.entries(bgp_map.as_groups)) {
                    const asNodes = routers.map(r => cy.getElementById(r));
                    const asPos = asNodes.reduce((acc, node) => {
                        const pos = node.position();
                        return {
                            x: acc.x + pos.x / asNodes.length,
                            y: acc.y + pos.y / asNodes.length
                        };
                    }, { x: 0, y: 0 });

                    cy.add({
                        group: 'nodes',
                        data: { id: `AS_${as_number}`, label: `AS ${as_number}` },
                        position: asPos,
                        classes: 'as-node'
                    });

                    asNodes.forEach(node => node.move({ parent: `AS_${as_number}` }));
                }

                // Manejo de eventos para mostrar información
                cy.on('tap', 'node', evt => {
                    const node = evt.target;
                    if (node.data('id') && !node.hasClass('as-node')) {
                        if (evt.originalEvent.detail === 2) { // Doble clic
                            alert(node.data('label') + '\n' + bgp_map.device_info[node.data('id')]);
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar el mapa BGP: ' + error.message);
            });
    </script>
</body>
</html>